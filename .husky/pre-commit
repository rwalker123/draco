echo "ğŸ” Running pre-commit checks for Draco Sports Manager..."

# Prevent commits to main branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "âŒ Direct commits to main branch are not allowed!"
    echo ""
    echo "ğŸ’¡ Please create a feature branch and use pull requests:"
    echo "   git checkout -b feature/your-feature-name"
    echo "   git add ."
    echo "   git commit -m 'Your commit message'"
    echo "   git push origin feature/your-feature-name"
    echo "   # Then create a pull request on GitHub"
    echo ""
    echo "ğŸ”’ This protects the main branch and ensures code review."
    exit 1
fi

# Run detect-secrets on staged files (without baseline to avoid updates)
STAGED_FILES=$(git diff --cached --name-only | grep -v '.secrets.baseline' | grep -v 'package.json' | tr '\n' ' ')
if [ -n "$STAGED_FILES" ]; then
  echo "ğŸ”’ Running detect-secrets pre-commit scan on staged files..."
  # Scan staged files without baseline to avoid modification
  ~/Library/Python/3.9/bin/detect-secrets-hook $STAGED_FILES
  if [ $? -ne 0 ]; then
    echo "âŒ detect-secrets found a potential secret in staged files. Commit blocked."
    echo ""
    echo "ğŸ’¡ To add a new secret to the baseline (if it's approved):"
    echo "   npm run secrets:update-baseline"
    echo "   git add .secrets.baseline && git commit -m 'Update baseline'"
    exit 1
  fi
fi

# Run lint-staged from root (prettier only)
echo "ğŸ¨ Running prettier on staged files..."
npx lint-staged
if [ $? -ne 0 ]; then
    echo "âŒ Prettier formatting failed"
    exit 1
fi

# Run ESLint fix on all workspaces
echo "ğŸ”§ Running ESLint fix on all workspaces..."
npm run lint:fix
if [ $? -ne 0 ]; then
    echo "âŒ ESLint fix failed"
    exit 1
fi

echo "âœ… All pre-commit checks passed" 