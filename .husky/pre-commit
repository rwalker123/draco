echo "🔍 Running pre-commit checks for Draco Sports Manager..."

# Run detect-secrets on staged files (without baseline to avoid updates)
STAGED_FILES=$(git diff --cached --name-only | grep -v '.secrets.baseline' | tr '\n' ' ')
if [ -n "$STAGED_FILES" ]; then
  echo "🔒 Running detect-secrets pre-commit scan on staged files..."
  # Scan staged files without baseline to avoid modification
  ~/Library/Python/3.9/bin/detect-secrets-hook $STAGED_FILES
  if [ $? -ne 0 ]; then
    echo "❌ detect-secrets found a potential secret in staged files. Commit blocked."
    echo ""
    echo "💡 To add a new secret to the baseline (if it's approved):"
    echo "   npm run secrets:update-baseline"
    echo "   git add .secrets.baseline && git commit -m 'Update baseline'"
    exit 1
  fi
fi

# Run backend checks
echo "📦 Checking backend..."
cd draco-nodejs/backend
npx lint-staged
BACKEND_EXIT_CODE=$?

# Run frontend checks
echo "🎨 Checking frontend..."
cd ../frontend
npx lint-staged
FRONTEND_EXIT_CODE=$?

# Return to root directory
cd ../..

# Check if either failed
if [ $BACKEND_EXIT_CODE -ne 0 ] || [ $FRONTEND_EXIT_CODE -ne 0 ]; then
    echo "❌ Pre-commit checks failed"
    exit 1
fi

echo "✅ All pre-commit checks passed" 